# Example 4: Loading quarterly aggregated data
# Demonstrates how to load and process quarterly summary data from nested directories

print("============================================================")
print("Example 4: Loading quarterly aggregated data")
print("============================================================")
print()

let base_path = getcwd() / "model_data"

print("ðŸ“‚ Loading quarterly data from nested directory structure")
print("  Base path: ", base_path)
print()

# Collect quarterly summary tables
let all_financial_summary = []
let all_regional_summary = []
let all_product_summary = []
let all_employee_performance = []

# Get list of year directories
let year_dirs = list_files(base_path)
print("  Found ", len(year_dirs), " items in base directory")
print()

# Process each year
for year_dir in year_dirs {
    # Skip items that are not directories
    if year_dir.name != "docs" and !contains(year_dir.name, ".") {        
        # Get list of month directories
        let month_dirs = list_files(year_dir)
        
        # Process each month
        for month_dir in month_dirs {
            if !contains(month_dir.name, ".") {
                
                # Get items in month directory
                let month_items = list_files(month_dir)
                
                # Look for quarterly directories (quarter_YYYY_QN)
                for item in month_items {
                    if contains(item.name, "quarter_") {
                        
                        print("  ðŸ“ Found quarterly directory: ", item)
                        
                        # Get files in quarterly directory
                        try {
                            let quarter_files = list_files(item)
                            
                            # Process each file
                            for quarter_file in quarter_files {
                                try {
                                    let data = read_file(quarter_file)
                                    
                                    # Categorize files by name pattern
                                    if contains(quarter_file.name, "financial_summary_") {
                                        all_financial_summary = push(all_financial_summary, data)
                                        print("    âœ“ Loaded financial_summary: ", quarter_file.name)
                                    }
                                    
                                    if contains(quarter_file.name, "regional_summary_") {
                                        all_regional_summary = push(all_regional_summary, data)
                                        print("    âœ“ Loaded regional_summary: ", quarter_file.name)
                                    }
                                    
                                    if contains(quarter_file.name, "product_summary_") {
                                        all_product_summary = push(all_product_summary, data)
                                        print("    âœ“ Loaded product_summary: ", quarter_file.name)
                                    }
                                    
                                    if contains(quarter_file.name, "employee_performance_") {
                                        all_employee_performance = push(all_employee_performance, data)
                                        print("    âœ“ Loaded employee_performance: ", quarter_file.name)
                                    }
                                } catch e {
                                    print("    âš ï¸  Error loading ", quarter_file.name, ": ", e)
                                }
                            }
                        } catch e {
                            print("    âš ï¸  Error reading quarterly directory: ", e)
                        }
                    }
                }
            }
        }
    }
}

print()
print("ðŸ“Š Summary of loaded quarterly data:")
print("  Financial summary files: ", len(all_financial_summary))
print("  Regional summary files: ", len(all_regional_summary))
print("  Product summary files: ", len(all_product_summary))
print("  Employee performance files: ", len(all_employee_performance))
print()

# Merge quarterly tables
print("ðŸ”— Merging quarterly tables...")

let financial_summary_all = null
let regional_summary_all = null
let product_summary_all = null
let employee_performance_all = null

if len(all_financial_summary) > 0 {
    financial_summary_all = merge_tables(all_financial_summary)
    if financial_summary_all != null {
        print("  âœ“ Merged financial summaries: ", len(financial_summary_all), " rows")
    }
}

if len(all_regional_summary) > 0 {
    regional_summary_all = merge_tables(all_regional_summary)
    if regional_summary_all != null {
        print("  âœ“ Merged regional summaries: ", len(regional_summary_all), " rows")
    }
}

if len(all_product_summary) > 0 {
    product_summary_all = merge_tables(all_product_summary)
    if product_summary_all != null {
        print("  âœ“ Merged product summaries: ", len(product_summary_all), " rows")
    }
}

if len(all_employee_performance) > 0 {
    employee_performance_all = merge_tables(all_employee_performance)
    if employee_performance_all != null {
        print("  âœ“ Merged employee performance reports: ", len(employee_performance_all), " rows")
    }
}
print()

print("============================================================")
print("âœ… Example 4 completed")
print("============================================================")

