# –¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –∏ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: datacode test_data_integrity.dc

print("============================================================")
print("üß™ –¢–µ—Å—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –∏ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö")
print("============================================================")
print()

global test_passed = 0
global test_failed = 0
global test_warnings = 0

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –≤—ã–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
global function assert_test(condition, message, is_warning) do
    if condition do
        print("  ‚úÖ ", message)
        test_passed = test_passed + 1
        return true
    else
        if is_warning do
            print("  ‚ö†Ô∏è  ", message)
            test_warnings = test_warnings + 1
        else
            print("  ‚ùå ", message)
            test_failed = test_failed + 1
        endif
        return false
    endif
endfunction

# –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∑–∫–∏)
print("üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...")
global base_path = getcwd() / "model_data"
global docs_path = base_path / "docs"

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
global product_catalog = null
global regions = null
global employees = null

try
    product_catalog = read_file(docs_path / "product_catalog.csv")
catch e
    print("  ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ product_catalog.csv: ", e)
endtry

try
    regions = read_file(docs_path / "regions.csv")
catch e
    print("  ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ regions.csv: ", e)
endtry

try
    employees = read_file(docs_path / "employees.csv")
catch e
    print("  ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ employees.csv: ", e)
endtry

print()

# ============================================================
# –¢–ï–°–¢ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
# ============================================================
print("üìã –¢–ï–°–¢ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤")
assert_test(not (product_catalog == null), "product_catalog –∑–∞–≥—Ä—É–∂–µ–Ω", false)
assert_test(not (regions == null), "regions –∑–∞–≥—Ä—É–∂–µ–Ω", false)
assert_test(not (employees == null), "employees –∑–∞–≥—Ä—É–∂–µ–Ω", false)

if not (product_catalog == null) do
    local catalog_len = len(product_catalog)
    local catalog_msg = "product_catalog —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ (" + catalog_len + " —Å—Ç—Ä–æ–∫)"
    local catalog_has_data = catalog_len > 0
    assert_test(catalog_has_data, catalog_msg, false)
    local catalog_correct_count = catalog_len == 50
    assert_test(catalog_correct_count, "product_catalog —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (50)", false)
endif

if not (regions == null) do
    local regions_len = len(regions)
    local regions_msg = "regions —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ (" + regions_len + " —Å—Ç—Ä–æ–∫)"
    local regions_has_data = regions_len > 0
    assert_test(regions_has_data, regions_msg, false)
    local regions_correct_count = regions_len == 10
    assert_test(regions_correct_count, "regions —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–≥–∏–æ–Ω–æ–≤ (10)", false)
endif

if not (employees == null) do
    local employees_len = len(employees)
    local employees_msg = "employees —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ (" + employees_len + " —Å—Ç—Ä–æ–∫)"
    local employees_has_data = employees_len > 0
    assert_test(employees_has_data, employees_msg, false)
    local employees_correct_count = employees_len == 30
    assert_test(employees_correct_count, "employees —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (30)", false)
endif
print()

# ============================================================
# –¢–ï–°–¢ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
# ============================================================
print("üìã –¢–ï–°–¢ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤")

if not (product_catalog == null) do
    local headers = table_headers(product_catalog)
    assert_test(contains(headers, "product_id"), "product_catalog —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–ª–æ–Ω–∫—É product_id", false)
    assert_test(contains(headers, "product_name"), "product_catalog —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–ª–æ–Ω–∫—É product_name", false)
    assert_test(contains(headers, "category"), "product_catalog —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–ª–æ–Ω–∫—É category", false)
endif

if not (regions == null) do
    local headers = table_headers(regions)
    assert_test(contains(headers, "region_code"), "regions —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–ª–æ–Ω–∫—É region_code", false)
    assert_test(contains(headers, "region_name"), "regions —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–ª–æ–Ω–∫—É region_name", false)
endif

if not (employees == null) do
    local headers = table_headers(employees)
    assert_test(contains(headers, "employee_id"), "employees —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–ª–æ–Ω–∫—É employee_id", false)
    assert_test(contains(headers, "employee_name"), "employees —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–ª–æ–Ω–∫—É employee_name", false)
endif
print()

# ============================================================
# –¢–ï–°–¢ 3: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ–∂–µ–º–µ—Å—è—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
# ============================================================
print("üìä –¢–ï–°–¢ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –µ–∂–µ–º–µ—Å—è—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö")

# –ó–∞–≥—Ä—É–∂–∞–µ–º –µ–∂–µ–º–µ—Å—è—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
global year_dirs = []
try
    year_dirs = list_files(base_path)
catch e
    print("  ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤: ", e)
endtry

global all_sales_tables = []
global all_inventory_tables = []
global all_refunds_tables = []
global all_marketing_tables = []

# –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
global expected_sales_files = 0
global expected_inventory_files = 0
global expected_refunds_files = 0
global expected_marketing_files = 0

for year_dir in year_dirs do
    if year_dir != "docs" and year_dir != "__pycache__" and year_dir != "generate_model_data.py" and not contains(year_dir, ".") do
        for month_dir_name in list_files(base_path / year_dir) do
            if contains(month_dir_name, ".") do
                next month_dir_name
            endif
            if not contains(month_dir_name, "quarter_") and not contains(month_dir_name, ".") do
                for file in list_files(base_path / year_dir / month_dir_name) do
                    if not contains(file, "quarter_") and contains(file, ".csv") do
                        if contains(file, "sales") do
                            expected_sales_files = expected_sales_files + 1
                        else if contains(file, "inventory") do
                            expected_inventory_files = expected_inventory_files + 1
                        else if contains(file, "refunds") do
                            expected_refunds_files = expected_refunds_files + 1
                        else if contains(file, "marketing_spend") do
                            expected_marketing_files = expected_marketing_files + 1
                        endif
                    endif
                next file
            endif
        next month_dir_name
    endif
next year_dir

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã
for year_dir in year_dirs do
    if year_dir != "docs" and year_dir != "__pycache__" and year_dir != "generate_model_data.py" and not contains(year_dir, ".") do
        for month_dir_name in list_files(base_path / year_dir) do
            if contains(month_dir_name, ".") do
                next month_dir_name
            endif
            if not contains(month_dir_name, "quarter_") and not contains(month_dir_name, ".") do
                for file in list_files(base_path / year_dir / month_dir_name) do
                    if not contains(file, "quarter_") and contains(file, ".csv") do
                        try
                            local data = read_file(base_path / year_dir / month_dir_name / file)
                            if contains(file, "sales") do
                                all_sales_tables = push(all_sales_tables, data)
                            else if contains(file, "inventory") do
                                all_inventory_tables = push(all_inventory_tables, data)
                            else if contains(file, "refunds") do
                                all_refunds_tables = push(all_refunds_tables, data)
                            else if contains(file, "marketing_spend") do
                                all_marketing_tables = push(all_marketing_tables, data)
                            endif
                        catch e
                            # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
                        endtry
                    endif
                next file
            endif
        next month_dir_name
    endif
next year_dir

local sales_files_count = len(all_sales_tables)
local sales_files_ok = sales_files_count > 0
local sales_files_msg = "–ó–∞–≥—Ä—É–∂–µ–Ω—ã —Ñ–∞–π–ª—ã sales (" + sales_files_count + " —Ñ–∞–π–ª–æ–≤)"
assert_test(sales_files_ok, sales_files_msg, false)

local inventory_files_count = len(all_inventory_tables)
local inventory_files_ok = inventory_files_count > 0
local inventory_files_msg = "–ó–∞–≥—Ä—É–∂–µ–Ω—ã —Ñ–∞–π–ª—ã inventory (" + inventory_files_count + " —Ñ–∞–π–ª–æ–≤)"
assert_test(inventory_files_ok, inventory_files_msg, false)

local refunds_files_count = len(all_refunds_tables)
local refunds_files_ok = refunds_files_count > 0
local refunds_files_msg = "–ó–∞–≥—Ä—É–∂–µ–Ω—ã —Ñ–∞–π–ª—ã refunds (" + refunds_files_count + " —Ñ–∞–π–ª–æ–≤)"
assert_test(refunds_files_ok, refunds_files_msg, false)

local marketing_files_count = len(all_marketing_tables)
local marketing_files_ok = marketing_files_count > 0
local marketing_files_msg = "–ó–∞–≥—Ä—É–∂–µ–Ω—ã —Ñ–∞–π–ª—ã marketing (" + marketing_files_count + " —Ñ–∞–π–ª–æ–≤)"
assert_test(marketing_files_ok, marketing_files_msg, false)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ (–ø—Ä–∏–º–µ—Ä–Ω–æ)
local sales_files_enough = sales_files_count >= 30
assert_test(sales_files_enough, "–ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ñ–∞–π–ª–æ–≤ sales (–º–∏–Ω–∏–º—É–º 30)", true)
local inventory_files_enough = inventory_files_count >= 30
assert_test(inventory_files_enough, "–ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ñ–∞–π–ª–æ–≤ inventory (–º–∏–Ω–∏–º—É–º 30)", true)
local refunds_files_enough = refunds_files_count >= 30
assert_test(refunds_files_enough, "–ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ñ–∞–π–ª–æ–≤ refunds (–º–∏–Ω–∏–º—É–º 30)", true)
local marketing_files_enough = marketing_files_count >= 30
assert_test(marketing_files_enough, "–ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ñ–∞–π–ª–æ–≤ marketing (–º–∏–Ω–∏–º—É–º 30)", true)
print()

# ============================================================
# –¢–ï–°–¢ 4: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
# ============================================================
print("üîó –¢–ï–°–¢ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü")

global sales_all = null
global inventory_all = null
global refunds_all = null
global marketing_spend_all = null

if len(all_sales_tables) > 0 do
    try
        sales_all = merge_tables(all_sales_tables)
        assert_test(not (sales_all == null), "sales_all —É—Å–ø–µ—à–Ω–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∞", false)
        if not (sales_all == null) do
            local sales_len = len(sales_all)
            assert_test(sales_len > 0, "sales_all —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ (" + sales_len + " —Å—Ç—Ä–æ–∫)", false)
            local sales_enough = sales_len >= 10000
            assert_test(sales_enough, "sales_all —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö (–º–∏–Ω–∏–º—É–º 10000 —Å—Ç—Ä–æ–∫)", true)
        endif
    catch e
        assert_test(false, "–û—à–∏–±–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è sales: " + e, false)
    endtry
endif

if len(all_inventory_tables) > 0 do
    try
        inventory_all = merge_tables(all_inventory_tables)
        assert_test(not (inventory_all == null), "inventory_all —É—Å–ø–µ—à–Ω–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∞", false)
        if not (inventory_all == null) do
            local inventory_len = len(inventory_all)
            assert_test(inventory_len > 0, "inventory_all —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ (" + inventory_len + " —Å—Ç—Ä–æ–∫)", false)
        endif
    catch e
        assert_test(false, "–û—à–∏–±–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è inventory: " + e, false)
    endtry
endif

if len(all_refunds_tables) > 0 do
    try
        refunds_all = merge_tables(all_refunds_tables)
        assert_test(not (refunds_all == null), "refunds_all —É—Å–ø–µ—à–Ω–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∞", false)
        if not (refunds_all == null) do
            local refunds_len = len(refunds_all)
            assert_test(refunds_len > 0, "refunds_all —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ (" + refunds_len + " —Å—Ç—Ä–æ–∫)", false)
        endif
    catch e
        assert_test(false, "–û—à–∏–±–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è refunds: " + e, false)
    endtry
endif

if len(all_marketing_tables) > 0 do
    try
        marketing_spend_all = merge_tables(all_marketing_tables)
        assert_test(not (marketing_spend_all == null), "marketing_spend_all —É—Å–ø–µ—à–Ω–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∞", false)
        if not (marketing_spend_all == null) do
            local marketing_len = len(marketing_spend_all)
            assert_test(marketing_len > 0, "marketing_spend_all —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ (" + marketing_len + " —Å—Ç—Ä–æ–∫)", false)
        endif
    catch e
        assert_test(false, "–û—à–∏–±–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è marketing: " + e, false)
    endtry
endif
print()

# ============================================================
# –¢–ï–°–¢ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö (–≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏)
# ============================================================
print("üîó –¢–ï–°–¢ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö")

if not (sales_all == null) and not (product_catalog == null) do
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ product_id –≤ sales —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ product_catalog
    local sales_headers = table_headers(sales_all)
    local catalog_headers = table_headers(product_catalog)
    
    if contains(sales_headers, "product_id") and contains(catalog_headers, "product_id") do
        # –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ product_id –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞
        local catalog_product_ids = []
        for row in product_catalog do
            local pid = row["product_id"]
            if not contains(catalog_product_ids, pid) do
                catalog_product_ids = push(catalog_product_ids, pid)
            endif
        next row
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –∏–∑ sales
        local invalid_count = 0
        local checked_count = 0
        for row in sales_all do
            if checked_count < 100 do  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–µ 100 –∑–∞–ø–∏—Å–µ–π
                local pid = row["product_id"]
                if not contains(catalog_product_ids, pid) do
                    invalid_count = invalid_count + 1
                endif
                checked_count = checked_count + 1
            else
                break
            endif
        next row
        
        assert_test(invalid_count == 0, "–í—Å–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ product_id –≤ sales —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ product_catalog (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ " + checked_count + " –∑–∞–ø–∏—Å–µ–π)", true)
    endif
endif

if not (sales_all == null) and not (regions == null) do
    local sales_headers = table_headers(sales_all)
    local regions_headers = table_headers(regions)
    
    if contains(sales_headers, "region") and contains(regions_headers, "region_code") do
        # –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ region_code –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
        local region_codes = []
        for row in regions do
            local rc = row["region_code"]
            if not contains(region_codes, rc) do
                region_codes = push(region_codes, rc)
            endif
        next row
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –∏–∑ sales
        local invalid_count = 0
        local checked_count = 0
        for row in sales_all do
            if checked_count < 100 do
                local reg = row["region"]
                if not contains(region_codes, reg) do
                    invalid_count = invalid_count + 1
                endif
                checked_count = checked_count + 1
            else
                break
            endif
        next row
        
        assert_test(invalid_count == 0, "–í—Å–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ region –≤ sales —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ regions (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ " + checked_count + " –∑–∞–ø–∏—Å–µ–π)", true)
    endif
endif
print()

# ============================================================
# –¢–ï–°–¢ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
# ============================================================
print("üìà –¢–ï–°–¢ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤")

global all_financial_summary_tables = []
global all_regional_summary_tables = []
global all_product_summary_tables = []
global all_employee_performance_tables = []

for year_dir in year_dirs do
    if year_dir != "docs" and year_dir != "__pycache__" and year_dir != "generate_model_data.py" and not contains(year_dir, ".") do
        for month_dir_name in list_files(base_path / year_dir) do
            if contains(month_dir_name, ".") do
                next month_dir_name
            endif
            for item in list_files(base_path / year_dir / month_dir_name) do
                if contains(item, "quarter_") do
                    local quarter_files = null
                    try
                        quarter_files = list_files(base_path / year_dir / month_dir_name / item)
                    catch e
                        quarter_files = null
                    endtry
                    
                    if not (quarter_files == null) do
                        for quarter_file in quarter_files do
                            try
                                local data = read_file(base_path / year_dir / month_dir_name / item / quarter_file)
                                if contains(quarter_file, "financial_summary_") do
                                    all_financial_summary_tables = push(all_financial_summary_tables, data)
                                else if contains(quarter_file, "regional_summary_") do
                                    all_regional_summary_tables = push(all_regional_summary_tables, data)
                                else if contains(quarter_file, "product_summary_") do
                                    all_product_summary_tables = push(all_product_summary_tables, data)
                                else if contains(quarter_file, "employee_performance_") do
                                    all_employee_performance_tables = push(all_employee_performance_tables, data)
                                endif
                            catch e
                                # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
                            endtry
                        next quarter_file
                    endif
                endif
            next item
        next month_dir_name
    endif
next year_dir

local financial_files_count = len(all_financial_summary_tables)
local financial_files_ok = financial_files_count > 0
local financial_files_msg = "–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–µ financial_summary (" + financial_files_count + " —Ñ–∞–π–ª–æ–≤)"
assert_test(financial_files_ok, financial_files_msg, false)

local regional_files_count = len(all_regional_summary_tables)
local regional_files_ok = regional_files_count > 0
local regional_files_msg = "–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–µ regional_summary (" + regional_files_count + " —Ñ–∞–π–ª–æ–≤)"
assert_test(regional_files_ok, regional_files_msg, false)

local product_files_count = len(all_product_summary_tables)
local product_files_ok = product_files_count > 0
local product_files_msg = "–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–µ product_summary (" + product_files_count + " —Ñ–∞–π–ª–æ–≤)"
assert_test(product_files_ok, product_files_msg, false)

local employee_files_count = len(all_employee_performance_tables)
local employee_files_ok = employee_files_count > 0
local employee_files_msg = "–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–µ employee_performance (" + employee_files_count + " —Ñ–∞–π–ª–æ–≤)"
assert_test(employee_files_ok, employee_files_msg, false)

# –û–±—ä–µ–¥–∏–Ω—è–µ–º –∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
global financial_summary_all = null
global regional_summary_all = null
global product_summary_all = null
global employee_performance_all = null

if len(all_financial_summary_tables) > 0 do
    try
        financial_summary_all = merge_tables(all_financial_summary_tables)
        assert_test(not (financial_summary_all == null), "financial_summary_all —É—Å–ø–µ—à–Ω–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∞", false)
        if not (financial_summary_all == null) do
            local financial_len = len(financial_summary_all)
            local financial_has_data = financial_len > 0
            local financial_msg = "financial_summary_all —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ (" + financial_len + " —Å—Ç—Ä–æ–∫)"
            assert_test(financial_has_data, financial_msg, false)
        endif
    catch e
        assert_test(false, "–û—à–∏–±–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è financial_summary: " + e, false)
    endtry
endif

if len(all_regional_summary_tables) > 0 do
    try
        regional_summary_all = merge_tables(all_regional_summary_tables)
        assert_test(not (regional_summary_all == null), "regional_summary_all —É—Å–ø–µ—à–Ω–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∞", false)
    catch e
        assert_test(false, "–û—à–∏–±–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è regional_summary: " + e, false)
    endtry
endif

if len(all_product_summary_tables) > 0 do
    try
        product_summary_all = merge_tables(all_product_summary_tables)
        assert_test(not (product_summary_all == null), "product_summary_all —É—Å–ø–µ—à–Ω–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∞", false)
    catch e
        assert_test(false, "–û—à–∏–±–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è product_summary: " + e, false)
    endtry
endif

if len(all_employee_performance_tables) > 0 do
    try
        employee_performance_all = merge_tables(all_employee_performance_tables)
        assert_test(not (employee_performance_all == null), "employee_performance_all —É—Å–ø–µ—à–Ω–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∞", false)
    catch e
        assert_test(false, "–û—à–∏–±–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è employee_performance: " + e, false)
    endtry
endif
print()

# ============================================================
# –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
# ============================================================
print("============================================================")
print("üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤")
print("============================================================")
print("  ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: ", test_passed)
print("  ‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: ", test_failed)
print("  ‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: ", test_warnings)
print()

if test_failed == 0 do
    print("‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!")
else
    print("‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ –¥–∞–Ω–Ω—ã—Ö!")
endif

if test_warnings > 0 do
    print("‚ö†Ô∏è  –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤—ã—à–µ")
endif

print()

