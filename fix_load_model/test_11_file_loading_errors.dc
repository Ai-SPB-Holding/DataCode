# –¢–µ—Å—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö

print("============================================================")
print("–¢–ï–°–¢ 11: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤")
print("============================================================")
print()

# –ë–∞–∑–æ–≤—ã–π –ø—É—Ç—å –∫ –¥–∞–Ω–Ω—ã–º
global base_path = getcwd() / "model_data"

# –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ –≤—ã–≤–æ–¥–∞
global problematic_files = [
    ["2025", "09", "refunds_2025_09.csv"],
    ["2024", "06", "marketing_spend_2024_06.csv"],
    ["2023", "03", "inventory_2023_03.csv"]
]

print("üìÇ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤...")
print()

global files_checked = 0
global files_found = 0
global files_read_successfully = 0
global files_read_failed = 0

for file_info in problematic_files do
    local year = file_info[0]
    local month = file_info[1]
    local filename = file_info[2]
    
    files_checked = files_checked + 1
    
    print("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ ", files_checked, ": ", filename)
    print("  –ì–æ–¥: ", year, ", –ú–µ—Å—è—Ü: ", month)
    
    local file_path = base_path / year / month / filename
    print("  –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: ", file_path)
    print()
    
    # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ list_files
    print("  –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ list_files()...")
    try
        local month_dir = base_path / year / month
        local files = list_files(month_dir)
        print("    ‚úì list_files() –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ")
        print("    ‚úì –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: ", len(files))
        
        # –§—É–Ω–∫—Ü–∏—è file_exists
        global function file_exists(files, filename) do
            for file in files do
                if file == filename do
                    return true
                endif
            next file
            return false
        endfunction
        
        if file_exists(files, filename) do
            files_found = files_found + 1
            print("    ‚úì –§–∞–π–ª –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ")
        else
            print("    ‚úó –§–∞–π–ª –ù–ï –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ!")
            print("    ‚úó –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã: ", files)
        endif
    catch e
        print("    ‚úó –û—à–∏–±–∫–∞ –ø—Ä–∏ list_files(): ", e)
    endtry
    print()
    
    # –®–∞–≥ 2: –ü–æ–ø—ã—Ç–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞
    print("  –®–∞–≥ 2: –ü–æ–ø—ã—Ç–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞...")
    try
        local file_data = read_file(file_path)
        files_read_successfully = files_read_successfully + 1
        print("    ‚úì –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω!")
        print("    ‚úì –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö: ", typeof(file_data))
        
        if typeof(file_data) == "table" do
            print("    ‚úì –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫: ", len(file_data))
            print("    ‚úì –ó–∞–≥–æ–ª–æ–≤–∫–∏: ", table_headers(file_data))
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
            if len(file_data) > 0 do
                local headers = table_headers(file_data)
                print("    ‚úì –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫: ", len(headers))
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É
                local first_row = file_data[0]
                print("    ‚úì –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ (—Ç–∏–ø): ", typeof(first_row))
                if typeof(first_row) == "array" do
                    print("    ‚úì –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞—á–µ–Ω–∏–π –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ: ", len(first_row))
                endif
            endif
        endif
    catch e
        files_read_failed = files_read_failed + 1
        print("    ‚úó –û–®–ò–ë–ö–ê –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ", e)
        print("    ‚úó –¢–∏–ø –æ—à–∏–±–∫–∏: ", typeof(e))
        print("    ‚úó –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ (—Å—Ç—Ä–æ–∫–∞): ", "" + e)
    endtry
    print()
    
    print("  ==================================================")
    print()
next file_info

print("============================================================")
print("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤")
print("============================================================")
print()
print("  –í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ", files_checked)
print("  –§–∞–π–ª–æ–≤ –Ω–∞–π–¥–µ–Ω–æ: ", files_found)
print("  –§–∞–π–ª–æ–≤ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ: ", files_read_successfully)
print("  –§–∞–π–ª–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏ —á—Ç–µ–Ω–∏—è: ", files_read_failed)
print()

# –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–ª–æ–Ω–æ–∫ –≤ —Å—Ç—Ä–æ–∫–∞—Ö
print("============================================================")
print("üìã –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–ª–æ–Ω–æ–∫ –≤ —Å—Ç—Ä–æ–∫–∞—Ö")
print("============================================================")
print()

print("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ sales —Ñ–∞–π–ª–æ–≤ –Ω–∞ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–ª–æ–Ω–æ–∫...")
try
    local test_sales_file = base_path / "2025" / "01" / "sales_2025_01.csv"
    local test_sales_data = read_file(test_sales_file)
    
    if typeof(test_sales_data) == "table" do
        local headers = table_headers(test_sales_data)
        local expected_columns = len(headers)
        print("  –§–∞–π–ª: sales_2025_01.csv")
        print("  –û–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫: ", expected_columns)
        print("  –ó–∞–≥–æ–ª–æ–≤–∫–∏: ", headers)
        print()
        
        local rows_with_wrong_columns = 0
        local total_rows = len(test_sales_data)
        local sample_rows_checked = 0
        local max_sample = 100
        local rows_to_check = total_rows
        if total_rows > max_sample do
            rows_to_check = max_sample
        endif
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ —Ü–∏–∫–ª –ø–æ –º–∞—Å—Å–∏–≤—É
        local rows_to_iterate = []
        for i, _ in enum(test_sales_data) do
            rows_to_iterate = push(rows_to_iterate, i)
        next i

        print(" len(rows_to_iterate) = ", len(rows_to_iterate))
        
        for row_index in rows_to_iterate do
            local row = test_sales_data.idx[row_index]c
            if isinstance(row, array) do
                local actual_columns = len(row)
                if actual_columns != expected_columns do
                    rows_with_wrong_columns = rows_with_wrong_columns + 1
                    if rows_with_wrong_columns <= 5 do
                        print("    ‚ö†Ô∏è  –°—Ç—Ä–æ–∫–∞ ", row_index, ": –æ–∂–∏–¥–∞–ª–æ—Å—å ", expected_columns, " –∫–æ–ª–æ–Ω–æ–∫, –ø–æ–ª—É—á–µ–Ω–æ ", actual_columns)
                    endif
                endif
                sample_rows_checked = sample_rows_checked + 1
            endif
        next row_index
        
        print("  –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —Å—Ç—Ä–æ–∫: ", sample_rows_checked, " –∏–∑ ", total_rows)
        if rows_with_wrong_columns > 0 do
            print("  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫ —Å –Ω–µ–≤–µ—Ä–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–æ–ª–æ–Ω–æ–∫: ", rows_with_wrong_columns)
        else
            print("  ‚úì –í—Å–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫")
        endif
    endif
catch e
    print("  ‚úó –û—à–∏–±–∫–∞: ", e)
endtry
print()

print("============================================================")
print("‚úÖ –¢–ï–°–¢ 11 –ó–ê–í–ï–†–®–ï–ù")
print("============================================================")

