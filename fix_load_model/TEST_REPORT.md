# –û—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–µ–π

## –î–∞—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
2024-12-XX

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–µ–π –≤ –ø–∞–º—è—Ç–∏ ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `relate()` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ –ø—Ä–æ—Å—Ç—ã—Ö —Ç–µ—Å—Ç–∞—Ö
- ‚úÖ –°–≤—è–∑–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–µ—Å—Ç—Ä —Å–≤—è–∑–µ–π
- ‚úÖ –ü—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –ø—Ä–æ—Å—Ç—ã—Ö —Ç–∞–±–ª–∏—Ü —Å–≤—è–∑–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ –ë–î

**–¢–µ—Å—Ç—ã:**
- `test_relate_simple.dc` - ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç (1 —Å–≤—è–∑—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è)
- `test_relate_after_merge.dc` - ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç (1 —Å–≤—è–∑—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ merge_tables –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è)

**–í—ã–≤–æ–¥:**
```bash
üîç DEBUG relate_columns: Creating relation id[id] <-> id[id]
üîç DEBUG relate_columns: Added relation, total relations in registry: 1
üîç DEBUG: Found 1 relations in registry
üîç DEBUG: Wrote 1 relations to database
```

### 2. –¢–µ—Å—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ —Å–≤—è–∑–µ–π –≤ SQLite –ë–î ‚ùå

**–°—Ç–∞—Ç—É—Å:** –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è `load_model_data.dc`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°–∫—Ä–∏–ø—Ç `load_model_data.dc` —Å–æ–æ–±—â–∞–µ—Ç "–°–æ–∑–¥–∞–Ω–æ —Å–≤—è–∑–µ–π: 12"
- –ù–æ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ —Ä–µ–µ—Å—Ç—Ä–µ —Å–≤—è–∑–µ–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è 0 –∏–ª–∏ 1 —Å–≤—è–∑—å (—Ç–æ–ª—å–∫–æ –æ—Ç –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞ relate())
- –í –ë–î –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 1 —Å–≤—è–∑—å –≤–º–µ—Å—Ç–æ –æ–∂–∏–¥–∞–µ–º—ã—Ö 12

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
- –§—É–Ω–∫—Ü–∏—è `create_relation()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è 12 —Ä–∞–∑
- –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true` 12 —Ä–∞–∑
- –ù–æ —Ñ—É–Ω–∫—Ü–∏—è `relate()` –≤–Ω—É—Ç—Ä–∏ `create_relation()` –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –î–æ–±–∞–≤–ª–µ–Ω –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ `relate()` –≤ —Å–∫—Ä–∏–ø—Ç - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–µ—Å—Ç—Ä–∞ —Å–≤—è–∑–µ–π:**
```bash
üîç DEBUG: Found 0 relations in registry  # –ü—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–ø–ø–∏–Ω–≥–∞ —Ç–∞–±–ª–∏—Ü (Rc::ptr_eq) ‚ö†Ô∏è

**–°—Ç–∞—Ç—É—Å:** –ü—Ä–æ–±–ª–µ–º–∞ —Å –º–∞–ø–ø–∏–Ω–≥–æ–º –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- –í –ø—Ä–æ—Å—Ç—ã—Ö —Ç–µ—Å—Ç–∞—Ö –º–∞–ø–ø–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- Rc —É–∫–∞–∑–∞—Ç–µ–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–≤—è–∑–µ–π –∏ —ç–∫—Å–ø–æ—Ä—Ç–µ
- –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ –º–∞–ø–ø–∏–Ω–≥–µ, –∞ –≤ —Ç–æ–º, —á—Ç–æ —Å–≤—è–∑–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è

**–ü—Ä–∏–º–µ—Ä —É—Å–ø–µ—à–Ω–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞:**
```
Relation table1 Rc pointer: 0x152e10cd8
Table table1 (table1): Rc pointer = 0x152e10cd8  # –°–æ–≤–ø–∞–¥–∞–µ—Ç!
```

### 4. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ –æ–¥–Ω–æ–π —Å–≤—è–∑–∏ ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç

**–¢–µ—Å—Ç—ã:**
- `test_relate_simple.dc` - ‚úÖ 1 —Å–≤—è–∑—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è
- `test_relate_after_merge.dc` - ‚úÖ 1 —Å–≤—è–∑—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ merge_tables –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ë–î:**
```sql
SELECT COUNT(*) FROM _datacode_relations;
-- –†–µ–∑—É–ª—å—Ç–∞—Ç: 1
```

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π ‚ö†Ô∏è

**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

**–ù–∞–±–ª—é–¥–µ–Ω–∏—è:**
- –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `merge_tables()` –î–û —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–µ–π ‚úÖ
- –°–≤—è–∑–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –ü–û–°–õ–ï –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü ‚úÖ
- –≠–∫—Å–ø–æ—Ä—Ç –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ü–û–°–õ–ï –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°–≤—è–∑–∏, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ `create_relation()`, –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —Ä–µ–µ—Å—Ç—Ä
- –¢–æ–ª—å–∫–æ –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ `relate()` —Ä–∞–±–æ—Ç–∞–µ—Ç

### 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –ë–î ‚ùå

**–°—Ç–∞—Ç—É—Å:** –°–≤—è–∑–∏ –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- 12 —Å–≤—è–∑–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ `_datacode_relations`

**–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- 0-1 —Å–≤—è–∑–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ `_datacode_relations` (—Ç–æ–ª—å–∫–æ –æ—Ç –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞ relate())

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤:**
```bash
sqlite3 load_model_data.db "SELECT COUNT(*) FROM sqlite_master WHERE type='index' AND name LIKE 'idx_%';"
-- –†–µ–∑—É–ª—å—Ç–∞—Ç: 14 –∏–Ω–¥–µ–∫—Å–æ–≤ (—Ä–∞–±–æ—Ç–∞–µ—Ç)
```

## –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: create_relation() –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç relate() ‚ùå

**–°–∏–º–ø—Ç–æ–º—ã:**
- –§—É–Ω–∫—Ü–∏—è `create_relation()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true` 12 —Ä–∞–∑
- –°–∫—Ä–∏–ø—Ç –≤—ã–≤–æ–¥–∏—Ç "–°–æ–∑–¥–∞–Ω–æ —Å–≤—è–∑–µ–π: 12"
- –ù–æ `relate()` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ (–Ω–µ—Ç –æ—Ç–ª–∞–¥–æ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. –£—Å–ª–æ–≤–∏–µ `if contains(headers1, col1) and contains(headers2, col2)` –ª–æ–∂–Ω–æ
2. –û—à–∏–±–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `create_relation()` –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –Ω–æ –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è
3. –ü—Ä–æ–±–ª–µ–º–∞ —Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º —Ñ—É–Ω–∫—Ü–∏–π –≤ DataCode

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
- –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –≤ `create_relation()`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `relate()` –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è `headers1`, `headers2`, `col1`, `col2` –≤ —Ñ—É–Ω–∫—Ü–∏–∏

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:**
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `create_relation()` –≤ —Å–∫—Ä–∏–ø—Ç–µ
   - –ó–∞–º–µ–Ω–∏—Ç—å –≤—ã–∑–æ–≤—ã `create_relation()` –Ω–∞ –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã `relate()` (–≤—Ä–µ–º–µ–Ω–Ω–æ)
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–µ–µ—Å—Ç—Ä–∞ —Å–≤—è–∑–µ–π –ø–µ—Ä–µ–¥ —ç–∫—Å–ø–æ—Ä—Ç–æ–º

2. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
   - –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö DataCode
   - –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –¥–ª—è —Å–≤—è–∑–µ–π
   - –£–ª—É—á—à–∏—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥

## –§–∞–π–ª—ã —Ç–µ—Å—Ç–æ–≤

- `test_relate_simple.dc` - –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç relate()
- `test_relate_after_merge.dc` - —Ç–µ—Å—Ç relate() –ø–æ—Å–ª–µ merge_tables()
- `test_table_indexer.dc` - —Ç–µ—Å—Ç —Ä–∞–±–æ—Ç—ã table["column"]

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
# –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç
DATACODE_DEBUG=1 cargo run -- test_relate_simple.dc --build_model test_simple.db
sqlite3 test_simple.db "SELECT COUNT(*) FROM _datacode_relations;"

# –¢–µ—Å—Ç –ø–æ—Å–ª–µ merge
DATACODE_DEBUG=1 cargo run -- test_relate_after_merge.dc --build_model test_merge.db
sqlite3 test_merge.db "SELECT COUNT(*) FROM _datacode_relations;"

# –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç
DATACODE_DEBUG=1 cargo run -- load_model_data.dc --build_model
sqlite3 load_model_data.db "SELECT COUNT(*) FROM _datacode_relations;"
```

