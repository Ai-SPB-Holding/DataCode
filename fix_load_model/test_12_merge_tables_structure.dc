# –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü –ø–µ—Ä–µ–¥ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ–º
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø–æ—á–µ–º—É merge_tables –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã —Å –Ω–µ—Å–æ–≤–ø–∞–¥–∞—é—â–∏–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏

print("============================================================")
print("–¢–ï–°–¢ 12: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü –¥–ª—è merge_tables")
print("============================================================")
print()

# –ë–∞–∑–æ–≤—ã–π –ø—É—Ç—å –∫ –¥–∞–Ω–Ω—ã–º
global base_path = getcwd() / "model_data"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –º–∞—Å—Å–∏–≤–æ–≤ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä ==
global function headers_equal(headers1, headers2) do
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø—ã
    if typeof(headers1) != typeof(headers2) do
        return false
    endif
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É
    if len(headers1) != len(headers2) do
        return false
    endif
    
    # –ü—Ä—è–º–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–æ–≤
    local direct_compare = headers1 == headers2
    
    # –ï—Å–ª–∏ –ø—Ä—è–º–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ—ç–ª–µ–º–µ–Ω—Ç–Ω–æ —á–µ—Ä–µ–∑ enum
    if not direct_compare do
        # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ enum
        local enum1 = enum(headers1)
        local enum2 = enum(headers2)
        
        for pair1 in enum1 do
            local idx = pair1[0]
            local val1 = pair1[1]
            
            # –ù–∞—Ö–æ–¥–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å —Ç–µ–º –∂–µ –∏–Ω–¥–µ–∫—Å–æ–º –≤ enum2
            local val2 = null
            for pair2 in enum2 do
                if pair2[0] == idx do
                    val2 = pair2[1]
                    break
                endif
            next pair2
            
            if val2 == null or val1 != val2 do
                return false
            endif
        next pair1
    endif
    
    return true
endfunction

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã
global function check_table_structure(table, table_name) do
    if table == null do
        print("  ‚úó ", table_name, ": —Ç–∞–±–ª–∏—Ü–∞ —Ä–∞–≤–Ω–∞ null")
        return false
    endif
    
    if typeof(table) != "table" do
        print("  ‚úó ", table_name, ": —Ç–∏–ø –Ω–µ table, –ø–æ–ª—É—á–µ–Ω ", typeof(table))
        return false
    endif
    
    local headers = table_headers(table)
    local row_count = len(table)
    
    print("  ‚úì ", table_name, ":")
    print("    - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫: ", row_count)
    print("    - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫: ", len(headers))
    print("    - –ó–∞–≥–æ–ª–æ–≤–∫–∏: ", headers)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∫–æ–ª–æ–Ω–æ–∫
    if row_count > 0 do
        local sample_size = row_count
        if row_count > 10 do
            sample_size = 10
        endif
        local wrong_column_count = 0
        
        for i = 0 to sample_size - 1 do
            local row = table[i]
            if typeof(row) == "array" do
                if len(row) != len(headers) do
                    wrong_column_count = wrong_column_count + 1
                    if wrong_column_count <= 3 do
                        print("    ‚ö†Ô∏è  –°—Ç—Ä–æ–∫–∞ ", i, ": –æ–∂–∏–¥–∞–ª–æ—Å—å ", len(headers), " –∫–æ–ª–æ–Ω–æ–∫, –ø–æ–ª—É—á–µ–Ω–æ ", len(row))
                    endif
                endif
            endif
        next i
        
        if wrong_column_count > 0 do
            print("    ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫ —Å –Ω–µ–≤–µ—Ä–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–æ–ª–æ–Ω–æ–∫: ", wrong_column_count, " –∏–∑ ", sample_size)
        else
            print("    ‚úì –í—Å–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫")
        endif
    endif
    
    return true
endfunction

# –¢–µ—Å—Ç 1: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ sales —Ñ–∞–π–ª–æ–≤
print("üìä –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã sales —Ñ–∞–π–ª–æ–≤")
print()

global sales_tables = []
global sales_headers_list = []

# –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ sales —Ñ–∞–π–ª–æ–≤
local sales_files_to_test = [
    ["2025", "01"],
    ["2025", "02"],
    ["2025", "03"],
    ["2024", "01"],
    ["2024", "02"],
    ["2023", "01"],
    ["2023", "02"]
]

for file_info in sales_files_to_test do
    local year = file_info[0]
    local month = file_info[1]
    local filename = "sales_" + year + "_" + month + ".csv"
    local file_path = base_path / year / month / filename
    
    print("  –ó–∞–≥—Ä—É–∑–∫–∞: ", filename)
    try
        local table_data = read_file(file_path)
        if typeof(table_data) == "table" do
            sales_tables = push(sales_tables, table_data)
            local headers = table_headers(table_data)
            sales_headers_list = push(sales_headers_list, headers)
            print("    ‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ", len(table_data), " —Å—Ç—Ä–æ–∫, ", len(headers), " –∫–æ–ª–æ–Ω–æ–∫")
        endif
    catch e
        print("    ‚úó –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ", e)
    endtry
next file_info

print()
print("  –í—Å–µ–≥–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ sales —Ç–∞–±–ª–∏—Ü: ", len(sales_tables))
print()

# –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
if len(sales_headers_list) > 0 do
    print("  –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ sales —Ñ–∞–π–ª–æ–≤:")
    local base_headers = sales_headers_list[0]
    print("    –ë–∞–∑–æ–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏: ", base_headers)
    print()
    
    local matching_count = 0
    local mismatching_count = 0
    
    local index = 0
    for headers in sales_headers_list do
        local file_name = "sales_" + sales_files_to_test[index][0] + "_" + sales_files_to_test[index][1] + ".csv"
        
        # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        print("    [DEBUG] –°—Ä–∞–≤–Ω–µ–Ω–∏–µ ", file_name)
        print("      –¢–∏–ø base_headers: ", typeof(base_headers))
        print("      –¢–∏–ø headers: ", typeof(headers))
        print("      base_headers == headers: ", base_headers == headers)
        
        if headers_equal(headers, base_headers) do
            matching_count = matching_count + 1
            print("    ‚úì ", file_name, ": –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç")
        else
            mismatching_count = mismatching_count + 1
            print("    ‚úó ", file_name, ": –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ù–ï —Å–æ–≤–ø–∞–¥–∞—é—Ç!")
            print("      –û–∂–∏–¥–∞–ª–æ—Å—å: ", base_headers)
            print("      –ü–æ–ª—É—á–µ–Ω–æ: ", headers)
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–ª–∏—á–∏—è
            if len(headers) != len(base_headers) do
                print("      –†–∞–∑–Ω–∏—Ü–∞ –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ: –æ–∂–∏–¥–∞–ª–æ—Å—å ", len(base_headers), ", –ø–æ–ª—É—á–µ–Ω–æ ", len(headers))
            else
                # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ—ç–ª–µ–º–µ–Ω—Ç–Ω–æ
                local enum_base = enum(base_headers)
                local enum_headers = enum(headers)
                print("      –ü–æ—ç–ª–µ–º–µ–Ω—Ç–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ:")
                for pair_base in enum_base do
                    local idx = pair_base[0]
                    local val_base = pair_base[1]
                    local val_headers = null
                    for pair_headers in enum_headers do
                        if pair_headers[0] == idx do
                            val_headers = pair_headers[1]
                            break
                        endif
                    next pair_headers
                    if val_headers != null and val_base != val_headers do
                        print("        [", idx, "] '", val_base, "' != '", val_headers, "'")
                    endif
                next pair_base
            endif
        endif
        index = index + 1
    next headers
    
    print()
    print("  –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
    print("    –°–æ–≤–ø–∞–¥–∞—é—â–∏—Ö: ", matching_count)
    print("    –ù–µ—Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö: ", mismatching_count)
endif
print()

# –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ inventory —Ñ–∞–π–ª–æ–≤
print("üìä –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã inventory —Ñ–∞–π–ª–æ–≤")
print()

global inventory_tables = []
global inventory_headers_list = []

local inventory_files_to_test = [
    ["2025", "01"],
    ["2025", "02"],
    ["2024", "01"],
    ["2023", "01"],
    ["2023", "02"],
    ["2023", "04"]
]

for file_info in inventory_files_to_test do
    local year = file_info[0]
    local month = file_info[1]
    local filename = "inventory_" + year + "_" + month + ".csv"
    local file_path = base_path / year / month / filename
    
    print("  –ó–∞–≥—Ä—É–∑–∫–∞: ", filename)
    try
        local table_data = read_file(file_path)
        if typeof(table_data) == "table" do
            inventory_tables = push(inventory_tables, table_data)
            local headers = table_headers(table_data)
            inventory_headers_list = push(inventory_headers_list, headers)
            print("    ‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ", len(table_data), " —Å—Ç—Ä–æ–∫, ", len(headers), " –∫–æ–ª–æ–Ω–æ–∫")
        endif
    catch e
        print("    ‚úó –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ", e)
    endtry
next file_info

print()
print("  –í—Å–µ–≥–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ inventory —Ç–∞–±–ª–∏—Ü: ", len(inventory_tables))
print()

# –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ inventory
if len(inventory_headers_list) > 0 do
    print("  –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ inventory —Ñ–∞–π–ª–æ–≤:")
    local base_headers = inventory_headers_list[0]
    print("    –ë–∞–∑–æ–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏: ", base_headers)
    print()
    
    local matching_count = 0
    local mismatching_count = 0
    
    local index = 0
    for headers in inventory_headers_list do
        local file_name = "inventory_" + inventory_files_to_test[index][0] + "_" + inventory_files_to_test[index][1] + ".csv"
        
        if headers_equal(headers, base_headers) do
            matching_count = matching_count + 1
            print("    ‚úì ", file_name, ": –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç")
        else
            mismatching_count = mismatching_count + 1
            print("    ‚úó ", file_name, ": –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ù–ï —Å–æ–≤–ø–∞–¥–∞—é—Ç!")
            print("      –û–∂–∏–¥–∞–ª–æ—Å—å: ", base_headers)
            print("      –ü–æ–ª—É—á–µ–Ω–æ: ", headers)
        endif
        index = index + 1
    next headers
    
    print()
    print("  –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
    print("    –°–æ–≤–ø–∞–¥–∞—é—â–∏—Ö: ", matching_count)
    print("    –ù–µ—Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö: ", mismatching_count)
endif
print()

# –¢–µ—Å—Ç 3: –ò–º–∏—Ç–∞—Ü–∏—è merge_tables —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
print("üìä –¢–µ—Å—Ç 3: –ò–º–∏—Ç–∞—Ü–∏—è merge_tables —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π")
print()

if len(sales_tables) > 0 do
    print("  –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ sales —Ç–∞–±–ª–∏—Ü (", len(sales_tables), " —Ç–∞–±–ª–∏—Ü)...")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Ç–∞–±–ª–∏—Ü—É –ø–µ—Ä–µ–¥ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ–º
    local valid_tables = []
    local invalid_tables = []
    
    local base_headers = null
    if len(sales_headers_list) > 0 do
        base_headers = sales_headers_list[0]
    endif
    
    local index = 0
    for table in sales_tables do
        local headers = table_headers(table)
        
        if base_headers == null do
            base_headers = headers
            valid_tables = push(valid_tables, table)
            print("    ‚úì –¢–∞–±–ª–∏—Ü–∞ ", index, ": –ø—Ä–∏–Ω—è—Ç–∞ –∫–∞–∫ –±–∞–∑–æ–≤–∞—è (", len(headers), " –∫–æ–ª–æ–Ω–æ–∫)")
        else if headers_equal(headers, base_headers) do
            valid_tables = push(valid_tables, table)
            print("    ‚úì –¢–∞–±–ª–∏—Ü–∞ ", index, ": –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç")
        else
            invalid_tables = push(invalid_tables, index)
            print("    ‚úó –¢–∞–±–ª–∏—Ü–∞ ", index, ": –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ù–ï —Å–æ–≤–ø–∞–¥–∞—é—Ç!")
            print("      –û–∂–∏–¥–∞–ª–æ—Å—å: ", base_headers)
            print("      –ü–æ–ª—É—á–µ–Ω–æ: ", headers)
        endif
        
        index = index + 1
    next table
    
    print()
    print("  –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:")
    print("    –í–∞–ª–∏–¥–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü: ", len(valid_tables))
    print("    –ù–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü: ", len(invalid_tables))
    
    if len(invalid_tables) > 0 do
        print("    –ò–Ω–¥–µ–∫—Å—ã –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü: ", invalid_tables)
    endif
    print()
    
    # –ü—ã—Ç–∞–µ–º—Å—è –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤–∞–ª–∏–¥–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
    if len(valid_tables) > 0 do
        print("  –ü–æ–ø—ã—Ç–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è ", len(valid_tables), " –≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü...")
        try
            local merged = merge_tables(valid_tables)
            if merged != null do
                print("    ‚úì –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ: ", len(merged), " —Å—Ç—Ä–æ–∫")
            else
                print("    ‚úó –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–µ—Ä–Ω—É–ª–æ null")
            endif
        catch e
            print("    ‚úó –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–∏: ", e)
        endtry
    endif
endif
print()

print("============================================================")
print("‚úÖ –¢–ï–°–¢ 12 –ó–ê–í–ï–†–®–ï–ù")
print("============================================================")

